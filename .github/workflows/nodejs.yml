name: Test CI

on: [push, pull_request]

jobs:
  lint:
    name: Lint source code
    runs-on: ubuntu-latest
    steps:
    - name: Checkout ðŸ›Ž
      uses: actions/checkout@v2
    - name: Choose reporter for ReviewDog ðŸš¦
      uses: haya14busa/action-cond@v1
      id: reporter
      with:
        cond: github.event_name == 'pull_request'
        if_true: github-pr-review
        if_false: github-check
    - name: Run ESlint ðŸ§¹
      uses: reviewdog/action-eslint@v1
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        eslint_flags: --ext '.js' --ext '.ts' --ext '.tsx' .
        reporter: ${{ steps.reporter.outputs.value }}
      env:
        NODE_OPTIONS: '--max-old-space-size=8192'
        CYPRESS_INSTALL_BINARY: 0

  type_check:
    name: Check static types
    runs-on: ubuntu-latest
    steps:
    - name: Checkout ðŸ›Ž
      uses: actions/checkout@v2
    - name: Install NPM dependencies ðŸ“¦
      uses: bahmutov/npm-install@v1
      env:
        CYPRESS_INSTALL_BINARY: 0
    - name: Check types ðŸ§©
      uses: icrawl/action-tsc@v1

  test-unit:
    name: Run unit, smoke and integration tests
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip ci')"
    steps:
      - uses: actions/checkout@v2
      - uses: bahmutov/npm-install@v1
      - name: Run tests
        env:
          CI: true
          SKIP_PREFLIGHT_CHECK: true
        run: |
          yarn test --coverage
          yarn storybook --smoke-test
      # Save code coverage report
      # See https://github.com/actions/upload-artifact
      - uses: actions/upload-artifact@v2
        with:
          name: Code coverage
          path: coverage

  test-e2e:
    name: Run end-to-end tests
    runs-on: ubuntu-16.04
    if: "!contains(github.event.head_commit.message, 'skip ci')"
    steps:
      - uses: actions/checkout@v2
      - uses: cypress-io/github-action@v2
        timeout-minutes: 10
        with:
          build: yarn build
          start: npx superstatic build -p 3000
          wait-on: 'http://localhost:3000'
      - uses: actions/upload-artifact@v2
        if: failure()
        with:
          name: screenshots & videos
          path: |
            cypress/screenshots
            cypress/videos

  visual-regression:
    name: Run visual regression tests
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip ci')"
    steps:
      - uses: actions/checkout@v2
      - uses: bahmutov/npm-install@v1
      - name: Run loki
        run: |
          yarn build-storybook
          yarn loki test --requireReference --reactUri file:./storybook-static
      - uses: actions/upload-artifact@v2
        if: failure()
        with:
          name: current and difference
          path: |
            .loki/current
            .loki/difference
